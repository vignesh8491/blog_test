# Title
> summary


## Todo

- [Done] Update TF
- [Done] Include metric
- [Done] Implement data augmentation
- [Done] Focal Loss
- [Done] loss weights

1. Experiment with model architecture
2. Explore data preprocessing(stratified sampling)

```python
import sys
#!{sys.executable} -m pip install matplotlib
#!{sys.executable} -m pip install tensorflow-addons

```

```python
import numpy as np
import pandas as pd
import pyarrow.parquet as pq
from PIL import Image as im
import tensorflow as tf
import psutil
import gc
import random
import math

from tensorflow import keras
from tensorflow.keras.layers import Input, Dense, Flatten
from tensorflow.keras.models import Model
from tensorflow.keras import optimizers
import tensorflow_addons as tfa
from tensorflow.keras import backend as K


from sklearn.metrics import accuracy_score, recall_score
from sklearn.model_selection import train_test_split
```

```python
tf.test.is_gpu_available()
```

    WARNING:tensorflow:From <ipython-input-3-17bb7203622b>:1: is_gpu_available (from tensorflow.python.framework.test_util) is deprecated and will be removed in a future version.
    Instructions for updating:
    Use `tf.config.list_physical_devices('GPU')` instead.





    True



```python

psutil.virtual_memory()
```




    svmem(total=33589370880, available=30772350976, percent=8.4, used=2354176000, free=22900391936, active=9134317568, inactive=1013571584, buffers=722624512, cached=7612178432, shared=8712192, slab=283185152)



```python
train_image = pd.DataFrame({})
```

```python
for i in range(4):
    if i==0:
        train_image = pd.read_parquet(f'train_image_data_{i}.parquet')
    else:
        train_image_part = pd.read_parquet(f'train_image_data_{i}.parquet')
        train_image = pd.concat([train_image,train_image_part])
```

```python
del train_image_part
gc.collect()
```




    24



```python
train = pd.read_csv('train.csv')
```

```python
train_image.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>image_id</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>...</th>
      <th>32322</th>
      <th>32323</th>
      <th>32324</th>
      <th>32325</th>
      <th>32326</th>
      <th>32327</th>
      <th>32328</th>
      <th>32329</th>
      <th>32330</th>
      <th>32331</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Train_0</td>
      <td>254</td>
      <td>253</td>
      <td>252</td>
      <td>253</td>
      <td>251</td>
      <td>252</td>
      <td>253</td>
      <td>251</td>
      <td>251</td>
      <td>...</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>251</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Train_1</td>
      <td>251</td>
      <td>244</td>
      <td>238</td>
      <td>245</td>
      <td>248</td>
      <td>246</td>
      <td>246</td>
      <td>247</td>
      <td>251</td>
      <td>...</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>254</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Train_2</td>
      <td>251</td>
      <td>250</td>
      <td>249</td>
      <td>250</td>
      <td>249</td>
      <td>245</td>
      <td>247</td>
      <td>252</td>
      <td>252</td>
      <td>...</td>
      <td>254</td>
      <td>253</td>
      <td>252</td>
      <td>252</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>251</td>
      <td>249</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Train_3</td>
      <td>247</td>
      <td>247</td>
      <td>249</td>
      <td>253</td>
      <td>253</td>
      <td>252</td>
      <td>251</td>
      <td>251</td>
      <td>250</td>
      <td>...</td>
      <td>254</td>
      <td>254</td>
      <td>254</td>
      <td>254</td>
      <td>254</td>
      <td>253</td>
      <td>253</td>
      <td>252</td>
      <td>251</td>
      <td>252</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Train_4</td>
      <td>249</td>
      <td>248</td>
      <td>246</td>
      <td>246</td>
      <td>248</td>
      <td>244</td>
      <td>242</td>
      <td>242</td>
      <td>229</td>
      <td>...</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 32333 columns</p>
</div>



```python
train_train_image = train.merge(train_image, on='image_id')
```

```python
del train_image
gc.collect()
```




    44



```python
train_train_image.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>image_id</th>
      <th>grapheme_root</th>
      <th>vowel_diacritic</th>
      <th>consonant_diacritic</th>
      <th>grapheme</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>...</th>
      <th>32322</th>
      <th>32323</th>
      <th>32324</th>
      <th>32325</th>
      <th>32326</th>
      <th>32327</th>
      <th>32328</th>
      <th>32329</th>
      <th>32330</th>
      <th>32331</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Train_0</td>
      <td>15</td>
      <td>9</td>
      <td>5</td>
      <td>ক্ট্রো</td>
      <td>254</td>
      <td>253</td>
      <td>252</td>
      <td>253</td>
      <td>251</td>
      <td>...</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>251</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Train_1</td>
      <td>159</td>
      <td>0</td>
      <td>0</td>
      <td>হ</td>
      <td>251</td>
      <td>244</td>
      <td>238</td>
      <td>245</td>
      <td>248</td>
      <td>...</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>254</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Train_2</td>
      <td>22</td>
      <td>3</td>
      <td>5</td>
      <td>খ্রী</td>
      <td>251</td>
      <td>250</td>
      <td>249</td>
      <td>250</td>
      <td>249</td>
      <td>...</td>
      <td>254</td>
      <td>253</td>
      <td>252</td>
      <td>252</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>253</td>
      <td>251</td>
      <td>249</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Train_3</td>
      <td>53</td>
      <td>2</td>
      <td>2</td>
      <td>র্টি</td>
      <td>247</td>
      <td>247</td>
      <td>249</td>
      <td>253</td>
      <td>253</td>
      <td>...</td>
      <td>254</td>
      <td>254</td>
      <td>254</td>
      <td>254</td>
      <td>254</td>
      <td>253</td>
      <td>253</td>
      <td>252</td>
      <td>251</td>
      <td>252</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Train_4</td>
      <td>71</td>
      <td>9</td>
      <td>5</td>
      <td>থ্রো</td>
      <td>249</td>
      <td>248</td>
      <td>246</td>
      <td>246</td>
      <td>248</td>
      <td>...</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
      <td>255</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 32337 columns</p>
</div>



```python
train_train_image.to_feather('train_train_image.feather')
```

## Start Execution from Here

```python
# Load preprocessed train data
train_train_image = pd.read_feather('train_train_image.feather')
```

```python
train_sample, val_sample = train_test_split(train_train_image, test_size=0.15, shuffle=True)
```

```python
train_sample.shape
```




    (170714, 32337)



```python
170714/64
```




    2667.40625



```python
train_sample.shape[0]/64
```




    2667.40625



```python
#Junk data
train_sample = train_train_image
val_sample = train_train_image
grapheme = train_sample.pop('grapheme')
image_id = train_sample.pop('image_id')

# Pop the labels
grapheme_root = train_sample.pop('grapheme_root')
vowel_diacritic = train_sample.pop('vowel_diacritic')
consonant_diacritic = train_sample.pop('consonant_diacritic')

#Val
#Junk data
val_grapheme = val_sample.pop('grapheme')
val_image_id = val_sample.pop('image_id')

# Pop the labels
val_grapheme_root = val_sample.pop('grapheme_root')
val_vowel_diacritic = val_sample.pop('vowel_diacritic')
val_consonant_diacritic = val_sample.pop('consonant_diacritic')

```


    ---------------------------------------------------------------------------

    KeyError                                  Traceback (most recent call last)

    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/pandas/core/indexes/base.py in get_loc(self, key, method, tolerance)
       2645             try:
    -> 2646                 return self._engine.get_loc(key)
       2647             except KeyError:


    pandas/_libs/index.pyx in pandas._libs.index.IndexEngine.get_loc()


    pandas/_libs/index.pyx in pandas._libs.index.IndexEngine.get_loc()


    pandas/_libs/hashtable_class_helper.pxi in pandas._libs.hashtable.PyObjectHashTable.get_item()


    pandas/_libs/hashtable_class_helper.pxi in pandas._libs.hashtable.PyObjectHashTable.get_item()


    KeyError: 'grapheme'

    
    During handling of the above exception, another exception occurred:


    KeyError                                  Traceback (most recent call last)

    <ipython-input-6-7ad09c7af594> in <module>
         12 #Val
         13 #Junk data
    ---> 14 val_grapheme = val_sample.pop('grapheme')
         15 val_image_id = val_sample.pop('image_id')
         16 


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/pandas/core/generic.py in pop(self, item)
        788         3  monkey        NaN
        789         """
    --> 790         result = self[item]
        791         del self[item]
        792         try:


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/pandas/core/frame.py in __getitem__(self, key)
       2798             if self.columns.nlevels > 1:
       2799                 return self._getitem_multilevel(key)
    -> 2800             indexer = self.columns.get_loc(key)
       2801             if is_integer(indexer):
       2802                 indexer = [indexer]


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/pandas/core/indexes/base.py in get_loc(self, key, method, tolerance)
       2646                 return self._engine.get_loc(key)
       2647             except KeyError:
    -> 2648                 return self._engine.get_loc(self._maybe_cast_indexer(key))
       2649         indexer = self.get_indexer([key], method=method, tolerance=tolerance)
       2650         if indexer.ndim > 1 or indexer.size > 1:


    pandas/_libs/index.pyx in pandas._libs.index.IndexEngine.get_loc()


    pandas/_libs/index.pyx in pandas._libs.index.IndexEngine.get_loc()


    pandas/_libs/hashtable_class_helper.pxi in pandas._libs.hashtable.PyObjectHashTable.get_item()


    pandas/_libs/hashtable_class_helper.pxi in pandas._libs.hashtable.PyObjectHashTable.get_item()


    KeyError: 'grapheme'


```python
# train image generator for tf dataset
def train_image_gen():
    for i in range(train_sample.shape[0]):
        yield train_sample.iloc[i].values
        
# val image generator for tf dataset
def val_image_gen():
    for i in range(val_sample.shape[0]):
        yield val_sample.iloc[i].values
```

```python
# Data loaded class using tf dataset
BATCH_SIZE=64
class DataLoader:
    
    def augment_images(self, imgs):
        
        #choose_augment
        do_augment = random.choice([True, False])
        do_brightness = random.choice([True, False])
        do_contrast = random.choice([True, False])
        do_central_crop = random.choice([False, False])
        do_rotate = random.choice([True, False])
        
        aug_imgs = imgs
        if do_augment:
            if do_brightness:
                aug_imgs = tf.image.random_brightness(aug_imgs,0.4,1)
            if do_contrast:
                aug_imgs = tf.image.random_contrast(aug_imgs,0.4,1)
            if do_central_crop:
                aug_imgs = tf.image.central_crop(aug_imgs,0.9)
            if do_rotate:
                rot_angle = random.choice(range(-10,10))
                interpolation_method = random.choice(['NEAREST', 'BILINEAR'])
                aug_imgs = tfa.image.rotate(aug_imgs, rot_angle*math.pi/180, interpolation_method)
        return aug_imgs
                
        
    
    def _get_train_images(self, mode,is_augment=False):
        #dataset = tf.data.Dataset.from_tensor_slices(train_train_image.values)
        if mode =='train':
            dataset = tf.data.Dataset.from_generator(train_image_gen,tf.int32)
            #dataset = dataset.batch(BATCH_SIZE)
        elif mode == 'val':
            dataset = tf.data.Dataset.from_generator(val_image_gen,tf.int32)
            #dataset = dataset.batch(BATCH_SIZE)
        dataset = dataset.map(lambda x:tf.reshape(x,(137,236)))
        dataset = dataset.map(lambda x:tf.cast(x,tf.dtypes.float32))
        dataset = dataset.map(lambda x:tf.expand_dims(x,axis=-1))
        dataset = dataset.map(lambda x:tf.image.resize(x,(128,128)))
        if is_augment:
            dataset = dataset.map(lambda x: self.augment_images(x))
        dataset = dataset.map(lambda x:(x-241.46)/42.05)
        return dataset
    
    def _get_train_labels(self,mode):
        if mode == 'train':
            dataset = tf.data.Dataset.from_tensor_slices((grapheme_root.values, vowel_diacritic.values, consonant_diacritic.values))
            #dataset = dataset.batch(BATCH_SIZE)
        elif mode == 'val':
            dataset = tf.data.Dataset.from_tensor_slices((val_grapheme_root.values, val_vowel_diacritic.values, val_consonant_diacritic.values))
            #dataset = dataset.batch(BATCH_SIZE)
        return dataset
   
    def get_data(self, mode='train'):
        if mode == 'train' or mode=='val':
            if mode == 'train':
                ds_train_images = self._get_train_images(mode,False)
            else:
                ds_train_images = self._get_train_images(mode)
            ds_train_labels = self._get_train_labels(mode)
            ds_train = tf.data.Dataset.zip((ds_train_images,ds_train_labels))
            if mode == 'train':
                ds_train = ds_train.shuffle(buffer_size=800)
                ds_train = ds_train.repeat()
                ds_train = ds_train.batch(BATCH_SIZE)
                ds_train = ds_train.prefetch(1000)
            return ds_train
            
```

```python
dl = DataLoader()
ds_train = dl.get_data(mode='train')
#ds_val = dl.get_data(mode='val')
```

```python
#Model
input_tensor = Input(shape=(128, 128,1))
#model = keras.applications.resnet50.ResNet50(input_tensor = input_tensor, weights=None,include_top=False)
model = keras.applications.mobilenet_v2.MobileNetV2(input_tensor = input_tensor, weights=None,include_top=False)
x = model.output
x = tf.keras.layers.GlobalAveragePooling2D()(x)
#x = Flatten()(x)
x = Dense(512, activation='relu')(x)
preds_root = Dense(168, activation='softmax')(x)

x2 = Dense(512, activation='relu')(x)
preds_vowel = Dense(11, activation='softmax')(x)

x3 = Dense(512, activation='relu')(x)
preds_cons = Dense(7, activation='softmax')(x)

model = Model(inputs=model.input, outputs=[preds_root,preds_vowel, preds_cons])
```

```python
model.summary()
```

    Model: "model"
    __________________________________________________________________________________________________
    Layer (type)                    Output Shape         Param #     Connected to                     
    ==================================================================================================
    input_1 (InputLayer)            [(None, 128, 128, 1) 0                                            
    __________________________________________________________________________________________________
    Conv1_pad (ZeroPadding2D)       (None, 129, 129, 1)  0           input_1[0][0]                    
    __________________________________________________________________________________________________
    Conv1 (Conv2D)                  (None, 64, 64, 32)   288         Conv1_pad[0][0]                  
    __________________________________________________________________________________________________
    bn_Conv1 (BatchNormalization)   (None, 64, 64, 32)   128         Conv1[0][0]                      
    __________________________________________________________________________________________________
    Conv1_relu (ReLU)               (None, 64, 64, 32)   0           bn_Conv1[0][0]                   
    __________________________________________________________________________________________________
    expanded_conv_depthwise (Depthw (None, 64, 64, 32)   288         Conv1_relu[0][0]                 
    __________________________________________________________________________________________________
    expanded_conv_depthwise_BN (Bat (None, 64, 64, 32)   128         expanded_conv_depthwise[0][0]    
    __________________________________________________________________________________________________
    expanded_conv_depthwise_relu (R (None, 64, 64, 32)   0           expanded_conv_depthwise_BN[0][0] 
    __________________________________________________________________________________________________
    expanded_conv_project (Conv2D)  (None, 64, 64, 16)   512         expanded_conv_depthwise_relu[0][0
    __________________________________________________________________________________________________
    expanded_conv_project_BN (Batch (None, 64, 64, 16)   64          expanded_conv_project[0][0]      
    __________________________________________________________________________________________________
    block_1_expand (Conv2D)         (None, 64, 64, 96)   1536        expanded_conv_project_BN[0][0]   
    __________________________________________________________________________________________________
    block_1_expand_BN (BatchNormali (None, 64, 64, 96)   384         block_1_expand[0][0]             
    __________________________________________________________________________________________________
    block_1_expand_relu (ReLU)      (None, 64, 64, 96)   0           block_1_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_1_pad (ZeroPadding2D)     (None, 65, 65, 96)   0           block_1_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_1_depthwise (DepthwiseCon (None, 32, 32, 96)   864         block_1_pad[0][0]                
    __________________________________________________________________________________________________
    block_1_depthwise_BN (BatchNorm (None, 32, 32, 96)   384         block_1_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_1_depthwise_relu (ReLU)   (None, 32, 32, 96)   0           block_1_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_1_project (Conv2D)        (None, 32, 32, 24)   2304        block_1_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_1_project_BN (BatchNormal (None, 32, 32, 24)   96          block_1_project[0][0]            
    __________________________________________________________________________________________________
    block_2_expand (Conv2D)         (None, 32, 32, 144)  3456        block_1_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_2_expand_BN (BatchNormali (None, 32, 32, 144)  576         block_2_expand[0][0]             
    __________________________________________________________________________________________________
    block_2_expand_relu (ReLU)      (None, 32, 32, 144)  0           block_2_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_2_depthwise (DepthwiseCon (None, 32, 32, 144)  1296        block_2_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_2_depthwise_BN (BatchNorm (None, 32, 32, 144)  576         block_2_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_2_depthwise_relu (ReLU)   (None, 32, 32, 144)  0           block_2_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_2_project (Conv2D)        (None, 32, 32, 24)   3456        block_2_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_2_project_BN (BatchNormal (None, 32, 32, 24)   96          block_2_project[0][0]            
    __________________________________________________________________________________________________
    block_2_add (Add)               (None, 32, 32, 24)   0           block_1_project_BN[0][0]         
                                                                     block_2_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_3_expand (Conv2D)         (None, 32, 32, 144)  3456        block_2_add[0][0]                
    __________________________________________________________________________________________________
    block_3_expand_BN (BatchNormali (None, 32, 32, 144)  576         block_3_expand[0][0]             
    __________________________________________________________________________________________________
    block_3_expand_relu (ReLU)      (None, 32, 32, 144)  0           block_3_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_3_pad (ZeroPadding2D)     (None, 33, 33, 144)  0           block_3_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_3_depthwise (DepthwiseCon (None, 16, 16, 144)  1296        block_3_pad[0][0]                
    __________________________________________________________________________________________________
    block_3_depthwise_BN (BatchNorm (None, 16, 16, 144)  576         block_3_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_3_depthwise_relu (ReLU)   (None, 16, 16, 144)  0           block_3_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_3_project (Conv2D)        (None, 16, 16, 32)   4608        block_3_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_3_project_BN (BatchNormal (None, 16, 16, 32)   128         block_3_project[0][0]            
    __________________________________________________________________________________________________
    block_4_expand (Conv2D)         (None, 16, 16, 192)  6144        block_3_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_4_expand_BN (BatchNormali (None, 16, 16, 192)  768         block_4_expand[0][0]             
    __________________________________________________________________________________________________
    block_4_expand_relu (ReLU)      (None, 16, 16, 192)  0           block_4_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_4_depthwise (DepthwiseCon (None, 16, 16, 192)  1728        block_4_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_4_depthwise_BN (BatchNorm (None, 16, 16, 192)  768         block_4_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_4_depthwise_relu (ReLU)   (None, 16, 16, 192)  0           block_4_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_4_project (Conv2D)        (None, 16, 16, 32)   6144        block_4_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_4_project_BN (BatchNormal (None, 16, 16, 32)   128         block_4_project[0][0]            
    __________________________________________________________________________________________________
    block_4_add (Add)               (None, 16, 16, 32)   0           block_3_project_BN[0][0]         
                                                                     block_4_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_5_expand (Conv2D)         (None, 16, 16, 192)  6144        block_4_add[0][0]                
    __________________________________________________________________________________________________
    block_5_expand_BN (BatchNormali (None, 16, 16, 192)  768         block_5_expand[0][0]             
    __________________________________________________________________________________________________
    block_5_expand_relu (ReLU)      (None, 16, 16, 192)  0           block_5_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_5_depthwise (DepthwiseCon (None, 16, 16, 192)  1728        block_5_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_5_depthwise_BN (BatchNorm (None, 16, 16, 192)  768         block_5_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_5_depthwise_relu (ReLU)   (None, 16, 16, 192)  0           block_5_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_5_project (Conv2D)        (None, 16, 16, 32)   6144        block_5_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_5_project_BN (BatchNormal (None, 16, 16, 32)   128         block_5_project[0][0]            
    __________________________________________________________________________________________________
    block_5_add (Add)               (None, 16, 16, 32)   0           block_4_add[0][0]                
                                                                     block_5_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_6_expand (Conv2D)         (None, 16, 16, 192)  6144        block_5_add[0][0]                
    __________________________________________________________________________________________________
    block_6_expand_BN (BatchNormali (None, 16, 16, 192)  768         block_6_expand[0][0]             
    __________________________________________________________________________________________________
    block_6_expand_relu (ReLU)      (None, 16, 16, 192)  0           block_6_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_6_pad (ZeroPadding2D)     (None, 17, 17, 192)  0           block_6_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_6_depthwise (DepthwiseCon (None, 8, 8, 192)    1728        block_6_pad[0][0]                
    __________________________________________________________________________________________________
    block_6_depthwise_BN (BatchNorm (None, 8, 8, 192)    768         block_6_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_6_depthwise_relu (ReLU)   (None, 8, 8, 192)    0           block_6_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_6_project (Conv2D)        (None, 8, 8, 64)     12288       block_6_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_6_project_BN (BatchNormal (None, 8, 8, 64)     256         block_6_project[0][0]            
    __________________________________________________________________________________________________
    block_7_expand (Conv2D)         (None, 8, 8, 384)    24576       block_6_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_7_expand_BN (BatchNormali (None, 8, 8, 384)    1536        block_7_expand[0][0]             
    __________________________________________________________________________________________________
    block_7_expand_relu (ReLU)      (None, 8, 8, 384)    0           block_7_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_7_depthwise (DepthwiseCon (None, 8, 8, 384)    3456        block_7_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_7_depthwise_BN (BatchNorm (None, 8, 8, 384)    1536        block_7_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_7_depthwise_relu (ReLU)   (None, 8, 8, 384)    0           block_7_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_7_project (Conv2D)        (None, 8, 8, 64)     24576       block_7_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_7_project_BN (BatchNormal (None, 8, 8, 64)     256         block_7_project[0][0]            
    __________________________________________________________________________________________________
    block_7_add (Add)               (None, 8, 8, 64)     0           block_6_project_BN[0][0]         
                                                                     block_7_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_8_expand (Conv2D)         (None, 8, 8, 384)    24576       block_7_add[0][0]                
    __________________________________________________________________________________________________
    block_8_expand_BN (BatchNormali (None, 8, 8, 384)    1536        block_8_expand[0][0]             
    __________________________________________________________________________________________________
    block_8_expand_relu (ReLU)      (None, 8, 8, 384)    0           block_8_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_8_depthwise (DepthwiseCon (None, 8, 8, 384)    3456        block_8_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_8_depthwise_BN (BatchNorm (None, 8, 8, 384)    1536        block_8_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_8_depthwise_relu (ReLU)   (None, 8, 8, 384)    0           block_8_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_8_project (Conv2D)        (None, 8, 8, 64)     24576       block_8_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_8_project_BN (BatchNormal (None, 8, 8, 64)     256         block_8_project[0][0]            
    __________________________________________________________________________________________________
    block_8_add (Add)               (None, 8, 8, 64)     0           block_7_add[0][0]                
                                                                     block_8_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_9_expand (Conv2D)         (None, 8, 8, 384)    24576       block_8_add[0][0]                
    __________________________________________________________________________________________________
    block_9_expand_BN (BatchNormali (None, 8, 8, 384)    1536        block_9_expand[0][0]             
    __________________________________________________________________________________________________
    block_9_expand_relu (ReLU)      (None, 8, 8, 384)    0           block_9_expand_BN[0][0]          
    __________________________________________________________________________________________________
    block_9_depthwise (DepthwiseCon (None, 8, 8, 384)    3456        block_9_expand_relu[0][0]        
    __________________________________________________________________________________________________
    block_9_depthwise_BN (BatchNorm (None, 8, 8, 384)    1536        block_9_depthwise[0][0]          
    __________________________________________________________________________________________________
    block_9_depthwise_relu (ReLU)   (None, 8, 8, 384)    0           block_9_depthwise_BN[0][0]       
    __________________________________________________________________________________________________
    block_9_project (Conv2D)        (None, 8, 8, 64)     24576       block_9_depthwise_relu[0][0]     
    __________________________________________________________________________________________________
    block_9_project_BN (BatchNormal (None, 8, 8, 64)     256         block_9_project[0][0]            
    __________________________________________________________________________________________________
    block_9_add (Add)               (None, 8, 8, 64)     0           block_8_add[0][0]                
                                                                     block_9_project_BN[0][0]         
    __________________________________________________________________________________________________
    block_10_expand (Conv2D)        (None, 8, 8, 384)    24576       block_9_add[0][0]                
    __________________________________________________________________________________________________
    block_10_expand_BN (BatchNormal (None, 8, 8, 384)    1536        block_10_expand[0][0]            
    __________________________________________________________________________________________________
    block_10_expand_relu (ReLU)     (None, 8, 8, 384)    0           block_10_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_10_depthwise (DepthwiseCo (None, 8, 8, 384)    3456        block_10_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_10_depthwise_BN (BatchNor (None, 8, 8, 384)    1536        block_10_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_10_depthwise_relu (ReLU)  (None, 8, 8, 384)    0           block_10_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_10_project (Conv2D)       (None, 8, 8, 96)     36864       block_10_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_10_project_BN (BatchNorma (None, 8, 8, 96)     384         block_10_project[0][0]           
    __________________________________________________________________________________________________
    block_11_expand (Conv2D)        (None, 8, 8, 576)    55296       block_10_project_BN[0][0]        
    __________________________________________________________________________________________________
    block_11_expand_BN (BatchNormal (None, 8, 8, 576)    2304        block_11_expand[0][0]            
    __________________________________________________________________________________________________
    block_11_expand_relu (ReLU)     (None, 8, 8, 576)    0           block_11_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_11_depthwise (DepthwiseCo (None, 8, 8, 576)    5184        block_11_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_11_depthwise_BN (BatchNor (None, 8, 8, 576)    2304        block_11_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_11_depthwise_relu (ReLU)  (None, 8, 8, 576)    0           block_11_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_11_project (Conv2D)       (None, 8, 8, 96)     55296       block_11_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_11_project_BN (BatchNorma (None, 8, 8, 96)     384         block_11_project[0][0]           
    __________________________________________________________________________________________________
    block_11_add (Add)              (None, 8, 8, 96)     0           block_10_project_BN[0][0]        
                                                                     block_11_project_BN[0][0]        
    __________________________________________________________________________________________________
    block_12_expand (Conv2D)        (None, 8, 8, 576)    55296       block_11_add[0][0]               
    __________________________________________________________________________________________________
    block_12_expand_BN (BatchNormal (None, 8, 8, 576)    2304        block_12_expand[0][0]            
    __________________________________________________________________________________________________
    block_12_expand_relu (ReLU)     (None, 8, 8, 576)    0           block_12_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_12_depthwise (DepthwiseCo (None, 8, 8, 576)    5184        block_12_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_12_depthwise_BN (BatchNor (None, 8, 8, 576)    2304        block_12_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_12_depthwise_relu (ReLU)  (None, 8, 8, 576)    0           block_12_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_12_project (Conv2D)       (None, 8, 8, 96)     55296       block_12_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_12_project_BN (BatchNorma (None, 8, 8, 96)     384         block_12_project[0][0]           
    __________________________________________________________________________________________________
    block_12_add (Add)              (None, 8, 8, 96)     0           block_11_add[0][0]               
                                                                     block_12_project_BN[0][0]        
    __________________________________________________________________________________________________
    block_13_expand (Conv2D)        (None, 8, 8, 576)    55296       block_12_add[0][0]               
    __________________________________________________________________________________________________
    block_13_expand_BN (BatchNormal (None, 8, 8, 576)    2304        block_13_expand[0][0]            
    __________________________________________________________________________________________________
    block_13_expand_relu (ReLU)     (None, 8, 8, 576)    0           block_13_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_13_pad (ZeroPadding2D)    (None, 9, 9, 576)    0           block_13_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_13_depthwise (DepthwiseCo (None, 4, 4, 576)    5184        block_13_pad[0][0]               
    __________________________________________________________________________________________________
    block_13_depthwise_BN (BatchNor (None, 4, 4, 576)    2304        block_13_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_13_depthwise_relu (ReLU)  (None, 4, 4, 576)    0           block_13_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_13_project (Conv2D)       (None, 4, 4, 160)    92160       block_13_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_13_project_BN (BatchNorma (None, 4, 4, 160)    640         block_13_project[0][0]           
    __________________________________________________________________________________________________
    block_14_expand (Conv2D)        (None, 4, 4, 960)    153600      block_13_project_BN[0][0]        
    __________________________________________________________________________________________________
    block_14_expand_BN (BatchNormal (None, 4, 4, 960)    3840        block_14_expand[0][0]            
    __________________________________________________________________________________________________
    block_14_expand_relu (ReLU)     (None, 4, 4, 960)    0           block_14_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_14_depthwise (DepthwiseCo (None, 4, 4, 960)    8640        block_14_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_14_depthwise_BN (BatchNor (None, 4, 4, 960)    3840        block_14_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_14_depthwise_relu (ReLU)  (None, 4, 4, 960)    0           block_14_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_14_project (Conv2D)       (None, 4, 4, 160)    153600      block_14_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_14_project_BN (BatchNorma (None, 4, 4, 160)    640         block_14_project[0][0]           
    __________________________________________________________________________________________________
    block_14_add (Add)              (None, 4, 4, 160)    0           block_13_project_BN[0][0]        
                                                                     block_14_project_BN[0][0]        
    __________________________________________________________________________________________________
    block_15_expand (Conv2D)        (None, 4, 4, 960)    153600      block_14_add[0][0]               
    __________________________________________________________________________________________________
    block_15_expand_BN (BatchNormal (None, 4, 4, 960)    3840        block_15_expand[0][0]            
    __________________________________________________________________________________________________
    block_15_expand_relu (ReLU)     (None, 4, 4, 960)    0           block_15_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_15_depthwise (DepthwiseCo (None, 4, 4, 960)    8640        block_15_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_15_depthwise_BN (BatchNor (None, 4, 4, 960)    3840        block_15_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_15_depthwise_relu (ReLU)  (None, 4, 4, 960)    0           block_15_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_15_project (Conv2D)       (None, 4, 4, 160)    153600      block_15_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_15_project_BN (BatchNorma (None, 4, 4, 160)    640         block_15_project[0][0]           
    __________________________________________________________________________________________________
    block_15_add (Add)              (None, 4, 4, 160)    0           block_14_add[0][0]               
                                                                     block_15_project_BN[0][0]        
    __________________________________________________________________________________________________
    block_16_expand (Conv2D)        (None, 4, 4, 960)    153600      block_15_add[0][0]               
    __________________________________________________________________________________________________
    block_16_expand_BN (BatchNormal (None, 4, 4, 960)    3840        block_16_expand[0][0]            
    __________________________________________________________________________________________________
    block_16_expand_relu (ReLU)     (None, 4, 4, 960)    0           block_16_expand_BN[0][0]         
    __________________________________________________________________________________________________
    block_16_depthwise (DepthwiseCo (None, 4, 4, 960)    8640        block_16_expand_relu[0][0]       
    __________________________________________________________________________________________________
    block_16_depthwise_BN (BatchNor (None, 4, 4, 960)    3840        block_16_depthwise[0][0]         
    __________________________________________________________________________________________________
    block_16_depthwise_relu (ReLU)  (None, 4, 4, 960)    0           block_16_depthwise_BN[0][0]      
    __________________________________________________________________________________________________
    block_16_project (Conv2D)       (None, 4, 4, 320)    307200      block_16_depthwise_relu[0][0]    
    __________________________________________________________________________________________________
    block_16_project_BN (BatchNorma (None, 4, 4, 320)    1280        block_16_project[0][0]           
    __________________________________________________________________________________________________
    Conv_1 (Conv2D)                 (None, 4, 4, 1280)   409600      block_16_project_BN[0][0]        
    __________________________________________________________________________________________________
    Conv_1_bn (BatchNormalization)  (None, 4, 4, 1280)   5120        Conv_1[0][0]                     
    __________________________________________________________________________________________________
    out_relu (ReLU)                 (None, 4, 4, 1280)   0           Conv_1_bn[0][0]                  
    __________________________________________________________________________________________________
    global_average_pooling2d (Globa (None, 1280)         0           out_relu[0][0]                   
    __________________________________________________________________________________________________
    dense (Dense)                   (None, 512)          655872      global_average_pooling2d[0][0]   
    __________________________________________________________________________________________________
    dense_1 (Dense)                 (None, 168)          86184       dense[0][0]                      
    __________________________________________________________________________________________________
    dense_3 (Dense)                 (None, 11)           5643        dense[0][0]                      
    __________________________________________________________________________________________________
    dense_5 (Dense)                 (None, 7)            3591        dense[0][0]                      
    ==================================================================================================
    Total params: 3,008,698
    Trainable params: 2,974,586
    Non-trainable params: 34,112
    __________________________________________________________________________________________________


```python
def bocr_score(y_true, y_pred):
    scores = []
    for i in range(3):
        y_true_subset = y_true[i]
        y_pred_subset = y_pred[i]
        scores.append(recall_score(y_true_subset, y_pred_subset, average='macro'))
    final_score = np.average(scores, weights=[2,1,1])
    return final_score
```

```python

def sparse_categorical_focal_crossentropy(y_true,
                               y_pred,
                               alpha=0.25,
                               gamma=2.0,
                               from_logits=False):
    if gamma and gamma < 0:
        raise ValueError(
            "Value of gamma should be greater than or equal to zero")

    # Get the cross_entropy for each entry
    sce = K.sparse_categorical_crossentropy(y_true, y_pred, from_logits=from_logits)

    # If logits are provided then convert the predictions into probabilities
    if from_logits:
        pred_prob = tf.sigmoid(y_pred)
    else:
        pred_prob = y_pred
   
    y_true = tf.cast(y_true, tf.dtypes.int32)
    y_true = tf.reshape(y_true, (-1,1))
    
    y_true = tf.one_hot(y_true, y_pred.shape[1])
    y_true = tf.squeeze(y_true, axis=1)
    
    p_t = y_pred*y_true
    y_pred_max = tf.math.reduce_max(p_t, axis=1)
    
    alpha_factor = 1.0
    modulating_factor = 1.0

    if alpha:
        alpha = tf.convert_to_tensor(alpha, dtype=K.floatx())
        alpha_factor = alpha

    if gamma:
        gamma = tf.convert_to_tensor(gamma, dtype=K.floatx())
        modulating_factor = tf.pow((1.0 - y_pred_max), gamma)

    # compute the final loss and return
    return tf.reduce_sum(alpha_factor * modulating_factor * sce, axis=-1)
```

```python
class SparseCategoricalFocalCrossEntropy(tf.keras.losses.Loss):
   

    def __init__(self,
                 from_logits=False,
                 alpha=0.001,
                 gamma=2.0,
                 reduction=tf.keras.losses.Reduction.NONE,
                 name='sigmoid_focal_crossentropy'):
        super(SparseCategoricalFocalCrossEntropy, self).__init__(
            name=name, reduction=reduction)

        self.from_logits = from_logits
        self.alpha = alpha
        self.gamma = gamma

    def call(self, y_true, y_pred):
        return sparse_categorical_focal_crossentropy(
            y_true,
            y_pred,
            alpha=self.alpha,
            gamma=self.gamma,
            from_logits=self.from_logits)

    def get_config(self):
        config = {
            "from_logits": self.from_logits,
            "alpha": self.alpha,
            "gamma": self.gamma,
        }
        base_config = super(SparseCategoricalFocalCrossEntropy, self).get_config()
        return dict(list(base_config.items()) + list(config.items()))
```

```python
#model.summary()
```

```python
adam = optimizers.Adam(learning_rate=0.0001)
model.compile(optimizer=adam, loss=SparseCategoricalFocalCrossEntropy(), loss_weights=[0.7,0.2,0.1], metrics = {'dense_1':tf.keras.metrics.SparseCategoricalAccuracy(),
                                                                                                         'dense_3':tf.keras.metrics.SparseCategoricalAccuracy(),
                                                                                                         'dense_5': tf.keras.metrics.SparseCategoricalAccuracy()})
```

```python
callbacks = [keras.callbacks.ModelCheckpoint('model_gap_fl_noaug/model_{epoch}.h5')]
```

```python
model.fit(ds_train, epochs=50, steps_per_epoch=3138, callbacks=callbacks)
```

    Train for 3138 steps
    Epoch 1/50
    3138/3138 [==============================] - 200s 64ms/step - loss: 0.1680 - dense_1_loss: 0.2212 - dense_3_loss: 0.0492 - dense_5_loss: 0.0332 - dense_1_sparse_categorical_accuracy: 0.1576 - dense_3_sparse_categorical_accuracy: 0.5715 - dense_5_sparse_categorical_accuracy: 0.6629
    Epoch 2/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0477 - dense_1_loss: 0.0626 - dense_3_loss: 0.0126 - dense_5_loss: 0.0134 - dense_1_sparse_categorical_accuracy: 0.6134 - dense_3_sparse_categorical_accuracy: 0.8571 - dense_5_sparse_categorical_accuracy: 0.8272
    Epoch 3/50
    3138/3138 [==============================] - 193s 61ms/step - loss: 0.0247 - dense_1_loss: 0.0320 - dense_3_loss: 0.0074 - dense_5_loss: 0.0083 - dense_1_sparse_categorical_accuracy: 0.7666 - dense_3_sparse_categorical_accuracy: 0.9126 - dense_5_sparse_categorical_accuracy: 0.8859
    Epoch 4/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0169 - dense_1_loss: 0.0217 - dense_3_loss: 0.0056 - dense_5_loss: 0.0063 - dense_1_sparse_categorical_accuracy: 0.8270 - dense_3_sparse_categorical_accuracy: 0.9324 - dense_5_sparse_categorical_accuracy: 0.9115
    Epoch 5/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0127 - dense_1_loss: 0.0161 - dense_3_loss: 0.0047 - dense_5_loss: 0.0053 - dense_1_sparse_categorical_accuracy: 0.8618 - dense_3_sparse_categorical_accuracy: 0.9429 - dense_5_sparse_categorical_accuracy: 0.9246
    Epoch 6/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0101 - dense_1_loss: 0.0126 - dense_3_loss: 0.0041 - dense_5_loss: 0.0046 - dense_1_sparse_categorical_accuracy: 0.8840 - dense_3_sparse_categorical_accuracy: 0.9490 - dense_5_sparse_categorical_accuracy: 0.9336
    Epoch 7/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0082 - dense_1_loss: 0.0100 - dense_3_loss: 0.0036 - dense_5_loss: 0.0042 - dense_1_sparse_categorical_accuracy: 0.9013 - dense_3_sparse_categorical_accuracy: 0.9549 - dense_5_sparse_categorical_accuracy: 0.9400
    Epoch 8/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0068 - dense_1_loss: 0.0083 - dense_3_loss: 0.0032 - dense_5_loss: 0.0038 - dense_1_sparse_categorical_accuracy: 0.9140 - dense_3_sparse_categorical_accuracy: 0.9585 - dense_5_sparse_categorical_accuracy: 0.9439
    Epoch 9/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0058 - dense_1_loss: 0.0070 - dense_3_loss: 0.0030 - dense_5_loss: 0.0036 - dense_1_sparse_categorical_accuracy: 0.9240 - dense_3_sparse_categorical_accuracy: 0.9611 - dense_5_sparse_categorical_accuracy: 0.9479
    Epoch 10/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0051 - dense_1_loss: 0.0060 - dense_3_loss: 0.0027 - dense_5_loss: 0.0033 - dense_1_sparse_categorical_accuracy: 0.9312 - dense_3_sparse_categorical_accuracy: 0.9642 - dense_5_sparse_categorical_accuracy: 0.9507
    Epoch 11/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0045 - dense_1_loss: 0.0053 - dense_3_loss: 0.0025 - dense_5_loss: 0.0032 - dense_1_sparse_categorical_accuracy: 0.9379 - dense_3_sparse_categorical_accuracy: 0.9660 - dense_5_sparse_categorical_accuracy: 0.9528
    Epoch 12/50
    3138/3138 [==============================] - 193s 61ms/step - loss: 0.0041 - dense_1_loss: 0.0047 - dense_3_loss: 0.0024 - dense_5_loss: 0.0030 - dense_1_sparse_categorical_accuracy: 0.9425 - dense_3_sparse_categorical_accuracy: 0.9678 - dense_5_sparse_categorical_accuracy: 0.9552
    Epoch 13/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0037 - dense_1_loss: 0.0042 - dense_3_loss: 0.0023 - dense_5_loss: 0.0029 - dense_1_sparse_categorical_accuracy: 0.9485 - dense_3_sparse_categorical_accuracy: 0.9693 - dense_5_sparse_categorical_accuracy: 0.9567
    Epoch 14/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0034 - dense_1_loss: 0.0039 - dense_3_loss: 0.0022 - dense_5_loss: 0.0027 - dense_1_sparse_categorical_accuracy: 0.9504 - dense_3_sparse_categorical_accuracy: 0.9707 - dense_5_sparse_categorical_accuracy: 0.9585
    Epoch 15/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0031 - dense_1_loss: 0.0035 - dense_3_loss: 0.0020 - dense_5_loss: 0.0026 - dense_1_sparse_categorical_accuracy: 0.9542 - dense_3_sparse_categorical_accuracy: 0.9719 - dense_5_sparse_categorical_accuracy: 0.9604
    Epoch 16/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0029 - dense_1_loss: 0.0032 - dense_3_loss: 0.0019 - dense_5_loss: 0.0025 - dense_1_sparse_categorical_accuracy: 0.9576 - dense_3_sparse_categorical_accuracy: 0.9730 - dense_5_sparse_categorical_accuracy: 0.9613
    Epoch 17/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0028 - dense_1_loss: 0.0031 - dense_3_loss: 0.0018 - dense_5_loss: 0.0024 - dense_1_sparse_categorical_accuracy: 0.9588 - dense_3_sparse_categorical_accuracy: 0.9743 - dense_5_sparse_categorical_accuracy: 0.9628
    Epoch 18/50
    3138/3138 [==============================] - 193s 62ms/step - loss: 0.0026 - dense_1_loss: 0.0029 - dense_3_loss: 0.0018 - dense_5_loss: 0.0023 - dense_1_sparse_categorical_accuracy: 0.9613 - dense_3_sparse_categorical_accuracy: 0.9745 - dense_5_sparse_categorical_accuracy: 0.9640
    Epoch 19/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0025 - dense_1_loss: 0.0028 - dense_3_loss: 0.0017 - dense_5_loss: 0.0022 - dense_1_sparse_categorical_accuracy: 0.9634 - dense_3_sparse_categorical_accuracy: 0.9758 - dense_5_sparse_categorical_accuracy: 0.9650
    Epoch 20/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0023 - dense_1_loss: 0.0025 - dense_3_loss: 0.0016 - dense_5_loss: 0.0022 - dense_1_sparse_categorical_accuracy: 0.9656 - dense_3_sparse_categorical_accuracy: 0.9772 - dense_5_sparse_categorical_accuracy: 0.9658
    Epoch 21/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0023 - dense_1_loss: 0.0025 - dense_3_loss: 0.0015 - dense_5_loss: 0.0021 - dense_1_sparse_categorical_accuracy: 0.9663 - dense_3_sparse_categorical_accuracy: 0.9780 - dense_5_sparse_categorical_accuracy: 0.9664
    Epoch 22/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0021 - dense_1_loss: 0.0023 - dense_3_loss: 0.0015 - dense_5_loss: 0.0021 - dense_1_sparse_categorical_accuracy: 0.9684 - dense_3_sparse_categorical_accuracy: 0.9781 - dense_5_sparse_categorical_accuracy: 0.9675
    Epoch 23/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0020 - dense_1_loss: 0.0022 - dense_3_loss: 0.0014 - dense_5_loss: 0.0020 - dense_1_sparse_categorical_accuracy: 0.9696 - dense_3_sparse_categorical_accuracy: 0.9793 - dense_5_sparse_categorical_accuracy: 0.9687
    Epoch 24/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0020 - dense_1_loss: 0.0021 - dense_3_loss: 0.0014 - dense_5_loss: 0.0019 - dense_1_sparse_categorical_accuracy: 0.9707 - dense_3_sparse_categorical_accuracy: 0.9795 - dense_5_sparse_categorical_accuracy: 0.9693
    Epoch 25/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0018 - dense_1_loss: 0.0020 - dense_3_loss: 0.0013 - dense_5_loss: 0.0019 - dense_1_sparse_categorical_accuracy: 0.9726 - dense_3_sparse_categorical_accuracy: 0.9807 - dense_5_sparse_categorical_accuracy: 0.9702
    Epoch 26/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0018 - dense_1_loss: 0.0020 - dense_3_loss: 0.0013 - dense_5_loss: 0.0018 - dense_1_sparse_categorical_accuracy: 0.9732 - dense_3_sparse_categorical_accuracy: 0.9811 - dense_5_sparse_categorical_accuracy: 0.9706
    Epoch 27/50
    3138/3138 [==============================] - 195s 62ms/step - loss: 0.0017 - dense_1_loss: 0.0019 - dense_3_loss: 0.0012 - dense_5_loss: 0.0018 - dense_1_sparse_categorical_accuracy: 0.9742 - dense_3_sparse_categorical_accuracy: 0.9818 - dense_5_sparse_categorical_accuracy: 0.9713
    Epoch 28/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0017 - dense_1_loss: 0.0018 - dense_3_loss: 0.0012 - dense_5_loss: 0.0017 - dense_1_sparse_categorical_accuracy: 0.9747 - dense_3_sparse_categorical_accuracy: 0.9819 - dense_5_sparse_categorical_accuracy: 0.9721
    Epoch 29/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0016 - dense_1_loss: 0.0018 - dense_3_loss: 0.0011 - dense_5_loss: 0.0017 - dense_1_sparse_categorical_accuracy: 0.9755 - dense_3_sparse_categorical_accuracy: 0.9826 - dense_5_sparse_categorical_accuracy: 0.9723
    Epoch 30/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0016 - dense_1_loss: 0.0017 - dense_3_loss: 0.0011 - dense_5_loss: 0.0017 - dense_1_sparse_categorical_accuracy: 0.9762 - dense_3_sparse_categorical_accuracy: 0.9827 - dense_5_sparse_categorical_accuracy: 0.9722
    Epoch 31/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0015 - dense_1_loss: 0.0016 - dense_3_loss: 0.0010 - dense_5_loss: 0.0016 - dense_1_sparse_categorical_accuracy: 0.9777 - dense_3_sparse_categorical_accuracy: 0.9837 - dense_5_sparse_categorical_accuracy: 0.9735
    Epoch 32/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0015 - dense_1_loss: 0.0016 - dense_3_loss: 0.0011 - dense_5_loss: 0.0016 - dense_1_sparse_categorical_accuracy: 0.9773 - dense_3_sparse_categorical_accuracy: 0.9836 - dense_5_sparse_categorical_accuracy: 0.9742
    Epoch 33/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0014 - dense_1_loss: 0.0015 - dense_3_loss: 9.9068e-04 - dense_5_loss: 0.0016 - dense_1_sparse_categorical_accuracy: 0.9789 - dense_3_sparse_categorical_accuracy: 0.9846 - dense_5_sparse_categorical_accuracy: 0.9746
    Epoch 34/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0014 - dense_1_loss: 0.0015 - dense_3_loss: 9.6511e-04 - dense_5_loss: 0.0015 - dense_1_sparse_categorical_accuracy: 0.9790 - dense_3_sparse_categorical_accuracy: 0.9843 - dense_5_sparse_categorical_accuracy: 0.9753
    Epoch 35/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0013 - dense_1_loss: 0.0014 - dense_3_loss: 9.1069e-04 - dense_5_loss: 0.0015 - dense_1_sparse_categorical_accuracy: 0.9799 - dense_3_sparse_categorical_accuracy: 0.9852 - dense_5_sparse_categorical_accuracy: 0.9750
    Epoch 36/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0013 - dense_1_loss: 0.0014 - dense_3_loss: 8.9583e-04 - dense_5_loss: 0.0015 - dense_1_sparse_categorical_accuracy: 0.9800 - dense_3_sparse_categorical_accuracy: 0.9852 - dense_5_sparse_categorical_accuracy: 0.9760
    Epoch 37/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0012 - dense_1_loss: 0.0013 - dense_3_loss: 8.7271e-04 - dense_5_loss: 0.0014 - dense_1_sparse_categorical_accuracy: 0.9806 - dense_3_sparse_categorical_accuracy: 0.9856 - dense_5_sparse_categorical_accuracy: 0.9765
    Epoch 38/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0012 - dense_1_loss: 0.0013 - dense_3_loss: 8.6336e-04 - dense_5_loss: 0.0014 - dense_1_sparse_categorical_accuracy: 0.9812 - dense_3_sparse_categorical_accuracy: 0.9860 - dense_5_sparse_categorical_accuracy: 0.9773
    Epoch 39/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0012 - dense_1_loss: 0.0012 - dense_3_loss: 8.0874e-04 - dense_5_loss: 0.0014 - dense_1_sparse_categorical_accuracy: 0.9824 - dense_3_sparse_categorical_accuracy: 0.9866 - dense_5_sparse_categorical_accuracy: 0.9776
    Epoch 40/50
    3138/3138 [==============================] - 195s 62ms/step - loss: 0.0012 - dense_1_loss: 0.0013 - dense_3_loss: 8.0577e-04 - dense_5_loss: 0.0013 - dense_1_sparse_categorical_accuracy: 0.9812 - dense_3_sparse_categorical_accuracy: 0.9866 - dense_5_sparse_categorical_accuracy: 0.9769
    Epoch 41/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0011 - dense_1_loss: 0.0012 - dense_3_loss: 7.8767e-04 - dense_5_loss: 0.0013 - dense_1_sparse_categorical_accuracy: 0.9827 - dense_3_sparse_categorical_accuracy: 0.9871 - dense_5_sparse_categorical_accuracy: 0.9779
    Epoch 42/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0011 - dense_1_loss: 0.0012 - dense_3_loss: 7.3539e-04 - dense_5_loss: 0.0013 - dense_1_sparse_categorical_accuracy: 0.9830 - dense_3_sparse_categorical_accuracy: 0.9876 - dense_5_sparse_categorical_accuracy: 0.9783
    Epoch 43/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0011 - dense_1_loss: 0.0012 - dense_3_loss: 7.7608e-04 - dense_5_loss: 0.0013 - dense_1_sparse_categorical_accuracy: 0.9832 - dense_3_sparse_categorical_accuracy: 0.9875 - dense_5_sparse_categorical_accuracy: 0.9784
    Epoch 44/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0011 - dense_1_loss: 0.0011 - dense_3_loss: 7.4600e-04 - dense_5_loss: 0.0012 - dense_1_sparse_categorical_accuracy: 0.9837 - dense_3_sparse_categorical_accuracy: 0.9876 - dense_5_sparse_categorical_accuracy: 0.9788
    Epoch 45/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0010 - dense_1_loss: 0.0011 - dense_3_loss: 7.1290e-04 - dense_5_loss: 0.0012 - dense_1_sparse_categorical_accuracy: 0.9841 - dense_3_sparse_categorical_accuracy: 0.9881 - dense_5_sparse_categorical_accuracy: 0.9790
    Epoch 46/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 0.0010 - dense_1_loss: 0.0011 - dense_3_loss: 7.2782e-04 - dense_5_loss: 0.0012 - dense_1_sparse_categorical_accuracy: 0.9840 - dense_3_sparse_categorical_accuracy: 0.9877 - dense_5_sparse_categorical_accuracy: 0.9796
    Epoch 47/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 9.8322e-04 - dense_1_loss: 0.0010 - dense_3_loss: 6.7945e-04 - dense_5_loss: 0.0012 - dense_1_sparse_categorical_accuracy: 0.9849 - dense_3_sparse_categorical_accuracy: 0.9885 - dense_5_sparse_categorical_accuracy: 0.9793
    Epoch 48/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 9.8843e-04 - dense_1_loss: 0.0011 - dense_3_loss: 6.7962e-04 - dense_5_loss: 0.0012 - dense_1_sparse_categorical_accuracy: 0.9847 - dense_3_sparse_categorical_accuracy: 0.9886 - dense_5_sparse_categorical_accuracy: 0.9802
    Epoch 49/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 9.4092e-04 - dense_1_loss: 9.9188e-04 - dense_3_loss: 6.6919e-04 - dense_5_loss: 0.0011 - dense_1_sparse_categorical_accuracy: 0.9851 - dense_3_sparse_categorical_accuracy: 0.9889 - dense_5_sparse_categorical_accuracy: 0.9805
    Epoch 50/50
    3138/3138 [==============================] - 194s 62ms/step - loss: 9.3661e-04 - dense_1_loss: 9.8243e-04 - dense_3_loss: 6.9097e-04 - dense_5_loss: 0.0011 - dense_1_sparse_categorical_accuracy: 0.9856 - dense_3_sparse_categorical_accuracy: 0.9885 - dense_5_sparse_categorical_accuracy: 0.9808





    <tensorflow.python.keras.callbacks.History at 0x7fab90255f50>



```python
model.load_weights('model_gap_fl_noaug/model_25.h5')
```

```python
for l in model.layers:
    l.trainable = False
model.trainable=False
```

```python
#for l in model.layers:
#    print(l.trainable)
```

```python
# training performance
res=[]
for d in ds_train.take(500):
    y_pred = model.predict(d[0])
    y_pred0 = np.argmax(y_pred[0],axis=1)
    y_pred1 = np.argmax(y_pred[1],axis=1)
    y_pred2 = np.argmax(y_pred[2],axis=1)
    
    r0 = recall_score(d[1][0],y_pred0, average='macro')
    r1 = recall_score(d[1][1],y_pred1, average='macro')
    r2 = recall_score(d[1][2],y_pred2, average='macro')
    
    r = (2*r0+r1+r2)/4
    res.append(r)
    #print(r)
```

```python


np.mean(res)
```




    0.9204087211019458



```python
# Test set
```

```python
preds_dict = {
    'grapheme_root': [],
    'vowel_diacritic': [],
    'consonant_diacritic': []
}
```

```python
components = ['consonant_diacritic', 'grapheme_root', 'vowel_diacritic']
target=[] # model predictions placeholder
row_id=[] # row_id place holder
for i in range(4):
    df = pd.read_parquet(f'test_image_data_{i}.parquet')
    df.set_index('image_id', inplace=True)
    index_values = df.index.values
    
    # train image generator for tf dataset
    def test_image_gen():
        for i in range(df.shape[0]):
            yield df.iloc[i].values
            
    dataset = tf.data.Dataset.from_generator(test_image_gen,tf.int32)
    dataset = dataset.map(lambda x:tf.reshape(x,(-1,137,236)))
    dataset = dataset.map(lambda x:tf.cast(x,tf.dtypes.float32))
    dataset = dataset.map(lambda x:tf.expand_dims(x,axis=-1))
    dataset = dataset.map(lambda x:tf.image.resize(x,(64,64)))
    dataset = dataset.map(lambda x:(x-241.46)/42.05)
    dataset = dataset.prefetch(100)
    preds = model.predict(dataset)
    #pred = [np.argmax(p,axis=1) for p in pred]
    
    for i, p in enumerate(preds_dict):
        preds_dict[p] = np.argmax(preds[i], axis=1)

    for k,id in enumerate(index_values):  
        for i,comp in enumerate(components):
            id_sample=id+'_'+comp
            row_id.append(id_sample)
            target.append(preds_dict[comp][k])
    
    del df
    gc.collect()
    

```


    ---------------------------------------------------------------------------

    ValueError                                Traceback (most recent call last)

    <ipython-input-25-1f6ab680ca5a> in <module>
         19     dataset = dataset.map(lambda x:(x-241.46)/42.05)
         20     dataset = dataset.prefetch(100)
    ---> 21     preds = model.predict(dataset)
         22     #pred = [np.argmax(p,axis=1) for p in pred]
         23 


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py in predict(self, x, batch_size, verbose, steps, callbacks, max_queue_size, workers, use_multiprocessing)
       1011         max_queue_size=max_queue_size,
       1012         workers=workers,
    -> 1013         use_multiprocessing=use_multiprocessing)
       1014 
       1015   def reset_metrics(self):


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2.py in predict(self, model, x, batch_size, verbose, steps, callbacks, max_queue_size, workers, use_multiprocessing, **kwargs)
        496         model, ModeKeys.PREDICT, x=x, batch_size=batch_size, verbose=verbose,
        497         steps=steps, callbacks=callbacks, max_queue_size=max_queue_size,
    --> 498         workers=workers, use_multiprocessing=use_multiprocessing, **kwargs)
        499 
        500 


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2.py in _model_iteration(self, model, mode, x, y, batch_size, verbose, sample_weight, steps, callbacks, max_queue_size, workers, use_multiprocessing, **kwargs)
        424           max_queue_size=max_queue_size,
        425           workers=workers,
    --> 426           use_multiprocessing=use_multiprocessing)
        427       total_samples = _get_total_number_of_samples(adapter)
        428       use_sample = total_samples is not None


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2.py in _process_inputs(model, mode, x, y, batch_size, epochs, sample_weights, class_weights, shuffle, steps, distribution_strategy, max_queue_size, workers, use_multiprocessing)
        704       max_queue_size=max_queue_size,
        705       workers=workers,
    --> 706       use_multiprocessing=use_multiprocessing)
        707 
        708   return adapter


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/data_adapter.py in __init__(self, x, y, sample_weights, standardize_function, **kwargs)
        700 
        701     if standardize_function is not None:
    --> 702       x = standardize_function(x)
        703 
        704     # Note that the dataset instance is immutable, its fine to reusing the user


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2.py in standardize_function(dataset)
        682           return x, y
        683         return x, y, sample_weights
    --> 684       return dataset.map(map_fn, num_parallel_calls=dataset_ops.AUTOTUNE)
        685 
        686   if mode == ModeKeys.PREDICT:


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/data/ops/dataset_ops.py in map(self, map_func, num_parallel_calls)
       1589     else:
       1590       return ParallelMapDataset(
    -> 1591           self, map_func, num_parallel_calls, preserve_cardinality=True)
       1592 
       1593   def flat_map(self, map_func):


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/data/ops/dataset_ops.py in __init__(self, input_dataset, map_func, num_parallel_calls, use_inter_op_parallelism, preserve_cardinality, use_legacy_function)
       3924         self._transformation_name(),
       3925         dataset=input_dataset,
    -> 3926         use_legacy_function=use_legacy_function)
       3927     self._num_parallel_calls = ops.convert_to_tensor(
       3928         num_parallel_calls, dtype=dtypes.int32, name="num_parallel_calls")


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/data/ops/dataset_ops.py in __init__(self, func, transformation_name, dataset, input_classes, input_shapes, input_types, input_structure, add_to_graph, use_legacy_function, defun_kwargs)
       3145       with tracking.resource_tracker_scope(resource_tracker):
       3146         # TODO(b/141462134): Switch to using garbage collection.
    -> 3147         self._function = wrapper_fn._get_concrete_function_internal()
       3148 
       3149         if add_to_graph:


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/eager/function.py in _get_concrete_function_internal(self, *args, **kwargs)
       2393     """Bypasses error checking when getting a graph function."""
       2394     graph_function = self._get_concrete_function_internal_garbage_collected(
    -> 2395         *args, **kwargs)
       2396     # We're returning this concrete function to someone, and they may keep a
       2397     # reference to the FuncGraph without keeping a reference to the


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/eager/function.py in _get_concrete_function_internal_garbage_collected(self, *args, **kwargs)
       2387       args, kwargs = None, None
       2388     with self._lock:
    -> 2389       graph_function, _, _ = self._maybe_define_function(args, kwargs)
       2390     return graph_function
       2391 


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/eager/function.py in _maybe_define_function(self, args, kwargs)
       2701 
       2702       self._function_cache.missed.add(call_context_key)
    -> 2703       graph_function = self._create_graph_function(args, kwargs)
       2704       self._function_cache.primary[cache_key] = graph_function
       2705       return graph_function, args, kwargs


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/eager/function.py in _create_graph_function(self, args, kwargs, override_flat_arg_shapes)
       2591             arg_names=arg_names,
       2592             override_flat_arg_shapes=override_flat_arg_shapes,
    -> 2593             capture_by_value=self._capture_by_value),
       2594         self._function_attributes,
       2595         # Tell the ConcreteFunction to clean up its graph once it goes out of


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/framework/func_graph.py in func_graph_from_py_func(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes)
        976                                           converted_func)
        977 
    --> 978       func_outputs = python_func(*func_args, **func_kwargs)
        979 
        980       # invariant: `func_outputs` contains only Tensors, CompositeTensors,


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/data/ops/dataset_ops.py in wrapper_fn(*args)
       3138           attributes=defun_kwargs)
       3139       def wrapper_fn(*args):  # pylint: disable=missing-docstring
    -> 3140         ret = _wrapper_helper(*args)
       3141         ret = structure.to_tensor_list(self._output_structure, ret)
       3142         return [ops.convert_to_tensor(t) for t in ret]


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/data/ops/dataset_ops.py in _wrapper_helper(*args)
       3080         nested_args = (nested_args,)
       3081 
    -> 3082       ret = autograph.tf_convert(func, ag_ctx)(*nested_args)
       3083       # If `func` returns a list of tensors, `nest.flatten()` and
       3084       # `ops.convert_to_tensor()` would conspire to attempt to stack


    ~/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/autograph/impl/api.py in wrapper(*args, **kwargs)
        235       except Exception as e:  # pylint:disable=broad-except
        236         if hasattr(e, 'ag_error_metadata'):
    --> 237           raise e.ag_error_metadata.to_exception(e)
        238         else:
        239           raise


    ValueError: in converted code:
    
        /home/gtaadmin/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2.py:677 map_fn
            batch_size=None)
        /home/gtaadmin/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py:2410 _standardize_tensors
            exception_prefix='input')
        /home/gtaadmin/anaconda3/envs/bocr/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_utils.py:582 standardize_input_data
            str(data_shape))
    
        ValueError: Error when checking input: expected input_1 to have shape (128, 128, 1) but got array with shape (64, 64, 1)



```python
submission = pd.DataFrame({'row_id': row_id,'target':target},columns = ['row_id','target'])
submission.to_csv('submission.csv',index=False)

```

```python
a = keras.applications.resnet50.ResNet50(input_tensor = input_tensor, weights=None,include_top=False)
```

```python
a.layers[5].trainable=False
```

```python
a.layers[5].trainable
```




    False


